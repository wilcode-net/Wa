name: Auto update wa.txt from wa-js (release vs nightly, by asset time)

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Pick newest between latest release and nightly (by wppconnect-wa.js asset updated_at)
        run: |
          set -e

          REPO="wppconnect-team/wa-js"
          ASSET_NAME="wppconnect-wa.js"

          # 1) Latest release/prerelease (exclude drafts)
          curl -s -H "Cache-Control: no-cache" \
            "https://api.github.com/repos/${REPO}/releases?per_page=50" \
            > releases.json

          jq -r '
            map(select(.draft == false))
            | sort_by(.updated_at // .created_at // .published_at)
            | last
          ' releases.json > newest_release.json

          # 2) Nightly release (fixed tag)
          curl -s -H "Cache-Control: no-cache" \
            "https://api.github.com/repos/${REPO}/releases/tags/nightly" \
            > nightly.json

          # Helper: extract asset updated_at + url
          get_asset_date() {
            jq -r --arg NAME "$ASSET_NAME" '
              .assets[]
              | select(.name==$NAME)
              | (.updated_at // .created_at)
            ' "$1"
          }

          get_asset_url() {
            jq -r --arg NAME "$ASSET_NAME" '
              .assets[]
              | select(.name==$NAME)
              | .browser_download_url
            ' "$1"
          }

          RELEASE_ASSET_DATE=$(get_asset_date newest_release.json)
          NIGHTLY_ASSET_DATE=$(get_asset_date nightly.json)

          RELEASE_URL=$(get_asset_url newest_release.json)
          NIGHTLY_URL=$(get_asset_url nightly.json)

          echo "Release asset date : $RELEASE_ASSET_DATE"
          echo "Nightly asset date : $NIGHTLY_ASSET_DATE"

          # Validate asset exists in both (or fallback)
          if [ -z "$RELEASE_URL" ] || [ "$RELEASE_URL" = "null" ]; then
            echo "WARN: Release asset not found, forcing nightly"
            cp nightly.json picked.json
          elif [ -z "$NIGHTLY_URL" ] || [ "$NIGHTLY_URL" = "null" ]; then
            echo "WARN: Nightly asset not found, forcing release"
            cp newest_release.json picked.json
          else
            # Compare ISO8601 strings directly
            if [ "$NIGHTLY_ASSET_DATE" \> "$RELEASE_ASSET_DATE" ]; then
              echo "✅ Pick nightly (asset newer)"
              cp nightly.json picked.json
            else
              echo "✅ Pick release (asset newer or equal)"
              cp newest_release.json picked.json
            fi
          fi

          TAG=$(jq -r '.tag_name' picked.json)
          REL_DATE=$(jq -r '.updated_at // .created_at // .published_at' picked.json)

          URL=$(jq -r --arg NAME "$ASSET_NAME" '
            .assets[]
            | select(.name==$NAME)
            | .browser_download_url
          ' picked.json)

          ASSET_DATE=$(jq -r --arg NAME "$ASSET_NAME" '
            .assets[]
            | select(.name==$NAME)
            | (.updated_at // .created_at)
          ' picked.json)

          echo "Picked tag : $TAG"
          echo "Release upd: $REL_DATE"
          echo "Asset upd  : $ASSET_DATE"
          echo "URL        : $URL"

          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "ERROR: Asset ${ASSET_NAME} not found in picked release!"
            echo "Assets available:"
            jq -r '.assets[].name' picked.json
            exit 1
          fi

          echo "$TAG" > .latest_tag
          echo "$REL_DATE" > .latest_date
          echo "$ASSET_DATE" > .latest_asset_date
          echo "$URL" > .download_url

      - name: Download wa.js
        run: |
          set -e
          URL=$(cat .download_url)

          # Cache bust (GitHub releases CDN đôi khi giữ lại)
          URL="$URL?ts=$(date +%s)"

          echo "Downloading: $URL"
          curl -L -H "Cache-Control: no-cache" "$URL" -o wa.new.js

      - name: Update wa.txt if changed
        run: |
          if [ -f wa.txt ] && cmp -s wa.new.js wa.txt; then
            echo "No changes detected. Skip update."
            exit 0
          fi
          mv wa.new.js wa.txt

      - name: Commit & push if needed
        run: |
          if git diff --quiet; then
            echo "Nothing to commit."
            exit 0
          fi

          TAG=$(cat .latest_tag)
          ASSET_DATE=$(cat .latest_asset_date)

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add wa.txt
          git commit -m "Auto Update ${TAG} (asset ${ASSET_DATE})"
          git push
